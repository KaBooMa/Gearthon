<div x-data="{mod: null, show_axis: true, show_controls: false, show_grid: true, show_wireframe: false}" x-init="async () => { mod = await eel.get_mod()();}">
    <div x-show="!mo" class="h-100" x-load="loading.html"></div>
    <div x-show="mod">
        <div class="d-flex h-100" x-data="editor">
            <div class="w-25 p-2 border-end">
                <div class="d-flex flex-column">
                    <!-- TODO: Setup form for this -->
                    <!-- <textarea class="form-control" placeholder="Enter mod description..."></textarea>
                    <button class="btn btn-primary mt-2">Apply Changes</button> -->
                    <!-- <div 
                        class="p-2"
                        x-load="form.html" 
                        x-data="{ form: null, data: mod }" 
                        x-init="async () => { form = await eel.get_form('Mod')() }"></div> -->
                    <button 
                        class="btn btn-success mt-2 w-100" 
                        type="submit" 
                        x-on:click="eel.save_mod(); loadPage('editor')">
                        Save Mod
                    </button>
                </div>
                <hr>

                <!-- Part Listing -->
                <div x-data="{ deleting: false, collapsed: false }">
                    <h5 class="d-flex">
                        <button class="btn fa-solid" :class="{ 'fa-chevron-up': !collapsed, 'fa-chevron-down': collapsed }" x-on:click="collapsed = !collapsed"></button>
                        Parts
                        <button class="btn fa-solid fa-plus ms-auto" x-on:click="eel.create_part(); loadPage('editor')"></button>
                        <button class="btn fa-solid fa-trash" x-on:click="deleting = !deleting"></button>
                    </h5>
                    <ul class="nav nav-pills flex-column" x-transition x-show="!collapsed">
                        <template x-for="part in mod?.parts">
                            <li class="nav-item d-flex">
                                <button class="btn btn-danger fa-solid fa-trash m-2" x-show="deleting" x-transition x-on:click="eel.delete_part(part.uid); loadPage('editor')"></button>
                                <button 
                                    class="btn w-100 my-2" 
                                    :class="{ 'btn-primary': part.uid == selected_part?.uid, 'btn-dark': part.uid != selected_part?.uid }" 
                                    x-text="part.display_name" 
                                    x-on:click="eel.select_part(part.uid); loadPage('editor')"></button>
                            </li>
                        </template>
                    </ul>
                </div>
                <hr>

                <!-- Link Type Listing -->
                <div x-data="{ deleting: false, collapsed: false }">
                    <h5 class="d-flex">
                        <button class="btn fa-solid" :class="{ 'fa-chevron-up': !collapsed, 'fa-chevron-down': collapsed }" x-on:click="collapsed = !collapsed"></button>
                        Link Types
                        <button class="btn fa-solid fa-plus ms-auto" x-on:click="eel.create_link_type(); loadPage('editor')"></button>
                        <button class="btn fa-solid fa-trash" x-on:click="deleting = !deleting"></button>
                    </h5>
                    <ul class="nav nav-pills flex-column" x-transition x-show="!collapsed">
                        <template x-for="link_type in mod?.link_types">
                            <li class="nav-item d-flex">
                                <button class="btn btn-danger fa-solid fa-trash m-2" x-show="deleting" x-transition x-on:click="eel.delete_link_type(part.uid); loadPage('editor')"></button>
                                <button 
                                    class="btn w-100 my-2" 
                                    :class="{ 'btn-primary': link_type.uid == selected_link_type?.uid, 'btn-dark': link_type.uid != selected_link_type?.uid }" 
                                    x-text="link_type.display_name" 
                                    x-on:click="eel.select_link_type(link_type.uid); loadPage('editor')"></button>
                            </li>
                        </template>
                    </ul>
                </div>
                <hr>

                <!-- Material Listing -->
                <div x-data="{ deleting: false, collapsed: false }">
                    <h5 class="d-flex">
                        <button class="btn fa-solid" :class="{ 'fa-chevron-up': !collapsed, 'fa-chevron-down': collapsed }" x-on:click="collapsed = !collapsed"></button>
                        Materials
                        <button class="btn fa-solid fa-plus ms-auto" x-on:click="eel.create_material(); loadPage('editor')"></button>
                        <button class="btn fa-solid fa-trash" x-on:click="deleting = !deleting"></button>
                    </h5>
                    <ul class="nav nav-pills flex-column" x-transition x-show="!collapsed">
                        <template x-for="material in mod?.materials">
                            <li class="nav-item d-flex">
                                <button class="btn btn-danger fa-solid fa-trash m-2" x-show="deleting" x-transition x-on:click="eel.delete_material(material.uid); loadPage('editor')"></button>
                                <button 
                                    class="btn w-100 my-2" 
                                    :class="{ 'btn-primary': material.uid == selected_material?.uid, 'btn-dark': material.uid != selected_material?.uid }" 
                                    x-text="material.display_name" 
                                    x-on:click="eel.select_material(material.uid); loadPage('editor')"></button>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>

            <!-- UI FOR MATERIAL EDITING -->
            <template x-if="selected_material">
                <div class="d-flex p-0 w-75" x-data="{ img_data: null }">
                    <div class="d-flex flex-column w-75">
                        <button class="btn btn-primary m-2" x-on:click="async () => { await eel.upload_material_texture()(); loadPage('editor') }">Upload</button>
                        <img class="rounded img-fluid border m-2" style="pointer-events: none;" x-bind:src="img_data" x-init="async () => {img_data = await eel.get_material_texture()()}">
                        
                    </div>
                    <div class="d-flex flex-column w-25 border-start p-2">
                        <h3 class="text-center">Settings</h3>
                        <hr>
                        <div 
                            class="p-2"
                            x-load="form.html" 
                            x-data="{ form: null, data: selected_material, update_func: eel.update_material }" 
                            x-init="async () => { form = await eel.get_form('Material')() }"></div>
                    </div>
                </div>
            </template>

            <!-- UI FOR LINK TYPE EDITING -->
            <template x-if="selected_link_type">
                <div class="d-flex flex-column p-4 w-75">
                    <h3 class="text-center">Settings</h3>
                    <hr>
                    <div 
                        class="p-2"
                        x-load="form.html" 
                        x-data="{ form: null, data: selected_link_type, update_func: eel.update_link_type }" 
                        x-init="async () => { form = await eel.get_form('LinkType')() }"></div>
                </div>
            </template>
        
            <!-- UI FOR PART EDITING -->
            <template x-if="selected_part">
                <div class="d-flex p-0 w-75">
                    <div class="d-flex flex-column p-0 w-75" style="min-width: 0rem;">
                        <nav class="nav navbar-expand navbar border-bottom">
                            <div class="container-fluid">
                                <ul class="navbar-nav">
                                    <li class="nav-item" x-data="{ open_file_browser: function() { $refs.filebrowser.click(); }}">
                                        <a class="nav-link" role="button" x-on:click="open_file_browser()">Upload Model</a>
                                        <input 
                                            class="form-control" 
                                            type="file" 
                                            hidden
                                            accept=".obj"
                                            x-ref="filebrowser"
                                            x-on:change="async () => { await uploadOBJ($event) }">
                                    </li>
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Mode</a>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" x-on:click="UpdateMode('View')">View <span class="text-secondary">[Ctrl+1]</span></a>
                                            <a class="dropdown-item" x-on:click="UpdateMode('Attachments')">Attachments <span class="text-secondary">[Ctrl+2]</span></a>
                                            <a class="dropdown-item" x-on:click="UpdateMode('Scripting')">Scripting <span class="text-secondary">[Ctrl+3]</span></a>
                                            <a class="dropdown-item" x-on:click="UpdateMode('Tweakables')">Tweakables <span class="text-secondary">[Ctrl+4]</span></a>
                                        </div>
                                    </li>
                                </ul>
                                <ul class="navbar-nav ms-auto">
                                    <li class="nav-item d-flex" x-data="{ open_file_browser: function() { $refs.filebrowser.click(); }}">
                                    </li>
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Options</a>
                                        <div class="dropdown-menu ps-2 " style="top:115%; left: -70px;">
                                          <h6 class="dropdown-header">Options</h6>
                                          <div class="form-check">
                                            <!-- TODO: Add persistance logic here -->
                                            <input class="form-check-input" type="checkbox" x-on:change="show_wireframe = !show_wireframe; showWireframe(show_wireframe);" id="showWireframeCheckBox">
                                            <label class="form-check-label" for="showWireframeCheckBox">Show Wireframe</label>
                                          </div>
                                          <div class="form-check">
                                            <!-- TODO: Add persistance logic here -->
                                            <input class="form-check-input" type="checkbox" x-on:change="show_controls = !show_controls" id="showControlsCheckBox">
                                            <label class="form-check-label" for="showControlsCheckBox">Show Controls</label>
                                          </div>                                        
                                          <div class="form-check">
                                            <!-- TODO: Add persistance logic here -->
                                            <input class="form-check-input" type="checkbox" checked="checked" x-on:change="show_grid = !show_grid; showGrid(show_grid);" id="showGridCheckBox">
                                            <label class="form-check-label" for="showGridCheckBox">Show Grid</label>
                                          </div>
                                          <div class="form-check">
                                            <!-- TODO: Add persistance logic here -->
                                            <input class="form-check-input" type="checkbox" checked="checked" x-on:change="show_axis = !show_axis; showAxis(show_axis);" id="showAxisCheckBox">
                                            <label class="form-check-label" for="showAxisCheckBox">Show Axis</label>
                                          </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </nav>
                        <div class="d-flex flex-column h-100 w-100">
                            <div class="h-100" id="3js" x-on:mousemove="MouseMove" x-on:mousedown="MouseDown" x-on:keydown="KeyDown" x-init="async() => { init3js(); loadOBJ(await eel.load_part_obj()()); }"></div>
                            <template x-if="mode == 'Scripting'">
                                <div class="h-100 w-50 p-2 position-fixed">
                                    <div id="editor" x-init="DisplayAce" class="h-75 rounded border shadow"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="bg-dark w-25 h-100 border-start overflow-auto">
                        <template x-if="mode == 'View'">
                            <div class="p-2">
                                <template x-if="show_controls">
                                    <div>
                                        <h3 class="text-center">Controls</h3>
                                        <hr>
                                        <ul>
                                            <li>Left Mouse - Rotate around model</li>
                                            <li>Right Mouse - Pan model</li>
                                            <li>Scroll Wheel - Zoom in/out of model</li>
                                        </ul>
                                    </div>
                                </template>
                                <!-- <template x-if="selected_part"> -->
                                    <div>
                                        <h3 class="text-center">Settings</h3>
                                        <hr>
                                        <div 
                                            class="p-2"
                                            x-load="form.html" 
                                            x-data="{ form: null, data: selected_part, update_func: eel.update_part }" 
                                            x-init="async () => { form = await eel.get_form('Part')() }"></div>
                                    </div>
                                <!-- </template> -->
                            </div>
                        </template>
                        <template x-if="mode == 'Attachments'">
                            <div class="p-2">
                                <template x-if="show_controls">
                                    <div>
                                        <h3 class="text-center">Controls</h3>
                                        <hr>
                                        <ul>
                                            <li>Left Click - Select attachment/link at cursor</li>
                                            <li>Ctrl + Left Click - Add new attachment</li>
                                            <li>Ctrl + Shift + Left Click - Add new link</li>
                                            <li>Right Click - Remove attachment/link at cursor</li>
                                            <li>Ctrl + Mouse Move - Move selected attachment/link to model at cursor</li>
                                            <li>Escape - Unselect current attachment/link</li>
                                        </ul>
                                    </div>
                                </template>
                                <template x-if="SelectedAttachment()">
                                    <div>
                                        <h3 class="text-center">Attachment</h3>
                                        <hr>
                                        <div 
                                            class="p-2" 
                                            x-load="form.html" 
                                            x-data="{ form: null, data: SelectedAttachment(), update_func: (kwargs) => { eel.update_part(kwargs)(); eel.update_part({'attachments': attachments})} }" 
                                            x-init="async () => { form = await eel.get_form('Attachment')() }"></div>
                                    </div>
                                </template>
                                <template x-if="SelectedLink()">
                                    <div>
                                        <h3 class="text-center">Link</h3>
                                        <hr>
                                        <div 
                                            class="p-2" 
                                            x-load="form.html" 
                                            x-data="{ form: null, data: SelectedLink(), update_func: (kwargs) => { eel.update_part(kwargs)(); eel.update_part({'links': links})} }" 
                                            x-init="async () => { form = await eel.get_form('Link')() }"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="mode == 'Scripting'">
                            <div class="p-2">
                                <h3 class="text-center">Tweakables</h3>
                                <hr>
                                <template x-for="tweakable in selected_part?.int_tweakables.concat(
                                    selected_part?.boolean_tweakables,
                                    selected_part?.joystick_tweakables,
                                    selected_part?.float_tweakables,
                                    selected_part?.string_tweakables,
                                    selected_part?.inputaction_tweakables,
                                )">
                                    <div class="p-2">
                                        <b x-text="tweakable.name"></b> - <span x-text="tweakable.type"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="mode == 'Tweakables'">
                            <div class="" x-data="{ selected_tweakable: null, form: null }">
                                <nav class="nav navbar-expand navbar border-bottom">
                                    <div class="container-fluid">
                                        <ul class="navbar-nav">
                                            <li class="nav-item dropdown">
                                                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Add</a>
                                                <div class="dropdown-menu">
                                                    <a class="dropdown-item" x-on:click="selected_part.int_tweakables.push({
                                                            'name': 'my_new_integer',
                                                            'label': 'New Integer',
                                                            'description': '',
                                                            'type': 'int',
                                                            'initial_value': 5,
                                                            'maximum': 10,
                                                            'minimum': 0
                                                        });
                                                        eel.update_part({'int_tweakables': selected_part.int_tweakables});
                                                        
                                                        selected_tweakable = null;
                                                        setTimeout(async () => {
                                                            selected_tweakable = selected_part.int_tweakables.at(-1);
                                                        }, 1);
                                                        ">Integer</a>
                                                    <a class="dropdown-item" x-on:click="selected_part.string_tweakables.push({
                                                            'name': 'my_new_string',
                                                            'label': 'New String',
                                                            'description': '',
                                                            'type': 'string',
                                                            'initial_value': '',
                                                            'multiline': false
                                                        });
                                                        eel.update_part({'string_tweakables': selected_part.string_tweakables});
                                                        
                                                        selected_tweakable = null;
                                                        setTimeout(async () => {
                                                            selected_tweakable = selected_part.string_tweakables.at(-1);
                                                        }, 1);
                                                        ">String</a>
                                                    <a class="dropdown-item" x-on:click="selected_part.boolean_tweakables.push({
                                                            'name': 'my_new_boolean',
                                                            'label': 'New Boolean',
                                                            'description': '',
                                                            'type': 'boolean',
                                                            'initial_value': false
                                                        });
                                                        eel.update_part({'boolean_tweakables': selected_part.boolean_tweakables});
                                                        
                                                        selected_tweakable = null;
                                                        setTimeout(async () => {
                                                            selected_tweakable = selected_part.boolean_tweakables.at(-1);
                                                        }, 1);
                                                        ">Boolean</a>
                                                    <a class="dropdown-item" x-on:click="selected_part.float_tweakables.push({
                                                            'name': 'my_new_float',
                                                            'label': 'New Float',
                                                            'description': '',
                                                            'type': 'float',
                                                            'initial_value': 0.5,
                                                            'maximum': 1.0,
                                                            'minimum': 0.0
                                                        });
                                                        eel.update_part({'float_tweakables': selected_part.float_tweakables});
                                                        
                                                        selected_tweakable = null;
                                                        setTimeout(async () => {
                                                            selected_tweakable = selected_part.float_tweakables.at(-1);
                                                        }, 1);
                                                        ">Float</a>
                                                    <a class="dropdown-item" x-on:click="selected_part.joystick_tweakables.push({
                                                            'name': 'my_new_joystick',
                                                            'label': 'New Joystick',
                                                            'description': '',
                                                            'type': 'joystick'
                                                        });
                                                        eel.update_part({'joystick_tweakables': selected_part.joystick_tweakables});
                                                        
                                                        selected_tweakable = null;
                                                        setTimeout(async () => {
                                                            selected_tweakable = selected_part.joystick_tweakables.at(-1);
                                                        }, 1);
                                                        ">Joystick</a>
                                                    <a class="dropdown-item" x-on:click="selected_part.inputaction_tweakables.push({
                                                            'name': 'my_new_inputaction',
                                                            'label': 'New Input Action',
                                                            'description': '',
                                                            'type': 'inputaction'
                                                        });
                                                        eel.update_part({'inputaction_tweakables': selected_part.inputaction_tweakables});
                                                        
                                                        selected_tweakable = null;
                                                        setTimeout(async () => {
                                                            selected_tweakable = selected_part.inputaction_tweakables.at(-1);
                                                        }, 1);
                                                        ">Input Action</a>
                                                </div>
                                            </li>
                                            <li class="nav-item dropdown">
                                                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Edit</a>
                                                <div class="dropdown-menu">
                                                    <template x-for="tweakable in [
                                                        ...selected_part?.int_tweakables, 
                                                        ...selected_part?.float_tweakables, 
                                                        ...selected_part?.boolean_tweakables, 
                                                        ...selected_part?.joystick_tweakables, 
                                                        ...selected_part?.inputaction_tweakables, 
                                                        ...selected_part?.string_tweakables
                                                    ]">
                                                        <a class="dropdown-item" 
                                                            x-text="tweakable.name"
                                                            x-on:click="() => {
                                                                selected_tweakable = null;
                                                                setTimeout(async () => {
                                                                    selected_tweakable = tweakable;
                                                                }, 1);
                                                            }"></a>
                                                    </template>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </nav>
                                <div class="p-2">
                                    <template x-if="selected_tweakable">
                                        <div x-data="{form: null}" x-init="
                                            form = selected_tweakable.type == 'int' ? await eel.get_form('IntTweakable')() :
                                            selected_tweakable.type == 'string' ? await eel.get_form('StringTweakable')() :
                                            selected_tweakable.type == 'boolean' ? await eel.get_form('BooleanTweakable')() :
                                            selected_tweakable.type == 'float' ? await eel.get_form('FloatTweakable')() :
                                            selected_tweakable.type == 'joystick' ? await eel.get_form('JoystickTweakable')() :
                                            selected_tweakable.type == 'inputaction' ? await eel.get_form('InputActionTweakable')() :
                                            null
                                            ">
                                            <button class="btn btn-danger ms-2 mt-2" x-on:click="
                                                selected_tweakable.type == 'int' ? selected_part.int_tweakables.splice(selected_part.int_tweakables.indexOf(selected_tweakable), 1) :
                                                selected_tweakable.type == 'string' ? selected_part.string_tweakables.splice(selected_part.string_tweakables.indexOf(selected_tweakable), 1) :
                                                selected_tweakable.type == 'boolean' ? selected_part.boolean_tweakables.splice(selected_part.boolean_tweakables.indexOf(selected_tweakable), 1) :
                                                selected_tweakable.type == 'float' ? selected_part.float_tweakables.splice(selected_part.float_tweakables.indexOf(selected_tweakable), 1) :
                                                selected_tweakable.type == 'joystick' ? selected_part.joystick_tweakables.splice(selected_part.joystick_tweakables.indexOf(selected_tweakable), 1) :
                                                selected_tweakable.type == 'inputaction' ? selected_part.inputaction_tweakables.splice(selected_part.inputaction_tweakables.indexOf(selected_tweakable), 1) :
                                                null;
                                                selected_tweakable = null;
                                                form = null;
                                                "><i class="fa-solid fa-trash"></i></button>
                                            <hr>
                                            <div 
                                                class="px-2" 
                                                x-data="{ data: selected_tweakable, update_func: (kwargs) => { eel.update_part(kwargs)(); eel.update_part({
                                                    'int_tweakables': selected_part.int_tweakables,
                                                    'string_tweakables': selected_part.string_tweakables,
                                                    'boolean_tweakables': selected_part.boolean_tweakables,
                                                    'float_tweakables': selected_part.float_tweakables,
                                                    'joystick_tweakables': selected_part.joystick_tweakables,
                                                    'inputaction_tweakables': selected_part.inputaction_tweakables,
                                                })}}"
                                                x-load="form.html"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
    Alpine.data('editor', () => ({
        attachments: [],
        selected_attachment_index: null,
        links: [],
        selected_link_index: null,
        mode: 'View',
        selected_part: null,
        selected_material: null,
        selected_link_type: null,
        part_form: null,

        async init() {
            document.addEventListener('keydown', (event) => {
                this.KeyDown(event);
            });

            this.selected_part = await eel.get_selected_part()(); 
            this.selected_material = await eel.get_material()(); 
            this.selected_link_type = await eel.get_link_type()(); 
            this.part_form = await eel.get_form('Part')();
            this.RenderExistingAttachments(this.selected_part.attachments);
            this.RenderExistingLinks(this.selected_part.links);
            setTimeout(Update3DContainer, 100);
        },

        DisplayAce() {
            ace.require("ace/ext/language_tools");
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/tomorrow_night");
            editor.getSession().setMode("ace/mode/lua");

            editor.getSession().on('change', (e) => {
                var code = editor.getValue();
                this.selected_part.script = code;
                eel.update_part({'script': code});
            });
            // var LuaCompleter = {
            //     getCompletions: function(editor, session, pos, prefix, callback) {
            //         // Define your custom functions and classes here
            //         var completions = [
            //             {name: "myFunction", value: "myFunction", meta: "function"},
            //             {name: "MyClass", value: "MyClass", meta: "class"}
            //             // Add more custom functions and classes as needed
            //         ];

            //         callback(null, completions);
            //     }
            // };
            editor.setOptions({
                enableBasicAutocompletion: true,
                enableSnippets: true,
                enableLiveAutocompletion: true
            })

            editor.setValue(this.selected_part.script);
            editor.moveCursorTo(0, 0);

            // editor.completers.push(LuaCompleter);
        },

        // ATTACHMENT SPECIFIC
        AddNewAttachment(position) {
            var obj = this.AddAttachment(
                'Attachment',
                ['fixed'],
                ['is_bidirectional'],
                position,
                { 'x': 0, 'y': 0, 'z': 0 },
                { 'x': 1, 'y': 1, 'z': 1 },
                true
            );
            this.SelectAttachmentByObject(obj);
        },

        AddAttachment(name, attachment_flags, alignment_flags, position, orientation, size, pivot) {
            var geometry = new THREE.ConeGeometry(0.01, 0.02, 8);
            var material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            var obj = new THREE.Mesh(geometry, material);

            this.attachments.push({
                'uuid': obj.uuid,
                'name': name,
                'attachment_flags': attachment_flags,
                'alignment_flags': alignment_flags,
                'position': position,
                'orientation': orientation,
                'size': size,
                'pivot': pivot
            });
            obj.name = 'attachment';

            // Add the attachment to the scene
            scene.add(obj);
            obj.position.copy(position);
            obj.rotation.x = THREE.MathUtils.degToRad(orientation.x);
            obj.rotation.y = THREE.MathUtils.degToRad(orientation.y);
            obj.rotation.z = THREE.MathUtils.degToRad(orientation.z);
            this.updatePositioning(obj.position, true, false);
            return obj;
        },

        SelectedAttachment() {
            return this.attachments[this.selected_attachment_index];
        },

        SelectedAttachmentObject() {
            var selected_attachment = this.attachments[this.selected_attachment_index];
            if (selected_attachment == null)
                return;

            return scene.children.filter(obj => obj.uuid == selected_attachment.uuid)[0];
        },

        SelectAttachmentByObject(obj) {
            for (i = 0; i < this.attachments.length; i++)
            {
                var attachment = this.attachments[i];
                if (attachment.uuid == obj.uuid)
                {
                    this.SelectAttachmentByIndex(i);
                    break;
                }
            }
        },

        RemoveAttachmentByObject(obj) {
            for (i = 0; i < this.attachments.length; i++)
            {
                var attachment = this.attachments[i];
                if (attachment.uuid == obj.uuid)
                {
                    this.attachments.pop(i);
                    if (this.selected_attachment_index == i)
                        this.selected_attachment_index = null;
                    scene.remove(obj);
                    break;
                }
            }
        },

        SelectAttachmentByIndex(index) {
            this.DeselectAttachment();
            setTimeout(() => {
                this.selected_attachment_index = index;
                this.SelectedAttachmentObject().material.color.set(0x0000ff);

            },1);
        },

        DeselectAttachment() {
            if (this.selected_attachment_index == null)
                return;


            this.SelectedAttachmentObject().material.color.set(0xff0000);
            this.selected_attachment_index = null;
        },

        RenderExistingAttachments(attachments) {
            attachments.forEach((attachment, index) => {
                this.AddAttachment(
                    attachment.name,
                    attachment.attachment_flags,
                    attachment.alignment_flags,
                    attachment.position,
                    attachment.orientation,
                    attachment.size,
                    attachment.pivot
                );
            });
        },
        
        // LINK SPECIFIC
        AddNewLink(position) {
            var obj = this.AddLink(
                'Link',
                'Power',
                position,
            );
            this.SelectLinkByObject(obj);
        },

        AddLink(name, link_type_name, position) {
            var geometry = new THREE.SphereGeometry(0.02, 8, 8);
            var material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            var obj = new THREE.Mesh(geometry, material);

            this.links.push({
                'uuid': obj.uuid,
                'name': name,
                'link_type_name': link_type_name,
                'position': position,
            });
            obj.name = 'link';

            // Add the attachment to the scene
            scene.add(obj);
            obj.position.copy(position);
            this.updatePositioning(obj.position, true, false);
            return obj;
        },

        SelectedLink() {
            return this.links[this.selected_link_index];
        },

        SelectedLinkObject() {
            var selected_link = this.links[this.selected_link_index];
            if (selected_link == null)
                return;

            return scene.children.filter(obj => obj.uuid == selected_link.uuid)[0];
        },

        SelectLinkByObject(obj) {
            for (i = 0; i < this.links.length; i++)
            {
                var link = this.links[i];
                if (link.uuid == obj.uuid)
                {
                    this.SelectLinkByIndex(i);
                    break;
                }
            }
        },

        RemoveLinkByObject(obj) {
            for (i = 0; i < this.links.length; i++)
            {
                var link = this.links[i];
                if (link.uuid == obj.uuid)
                {
                    this.links.pop(i);
                    if (this.selected_link_index == i)
                        this.selected_link_index = null;
                    scene.remove(obj);
                    break;
                }
            }
        },

        SelectLinkByIndex(index) {
            this.DeselectLink();
            setTimeout(() => {
                this.selected_link_index = index;
                this.SelectedLinkObject().material.color.set(0x0000ff);

            },1);
        },

        DeselectLink() {
            if (this.selected_link_index == null)
                return;


            this.SelectedLinkObject().material.color.set(0xff0000);
            this.selected_link_index = null;
        },

        RenderExistingLinks(links) {
            links.forEach((link, index) => {
                console.log(link);
                this.AddLink(
                    name=link.name,
                    link_type_name=link.link_type_name,
                    position=link.position,
                );
            });
        },

        UpdateMode(new_mode) {
            this.mode = new_mode;
            this.DeselectAttachment();
            this.DeselectLink();
            if (this.mode == "View") {
                showGrid(true);
            }
            
            if (this.mode == "Tweakables") {
                showGrid(true);
            }

            if (this.mode == "Attachments") {
                setTransparency(0.2);
                showGrid(false);
            } else {
                setTransparency(1);
            }
        },

        updatePositioning(exact_position, round, only_update_values) {
            
            var link = this.SelectedLinkObject();
            var attachment = this.SelectedAttachmentObject();

            if (attachment)
            {
                var attachment_data = this.SelectedAttachment();

                // Update with floats as this is the data we're expecting, not text
                attachment_data.orientation.x = parseFloat(attachment_data.orientation.x);
                attachment_data.orientation.y = parseFloat(attachment_data.orientation.y);
                attachment_data.orientation.z = parseFloat(attachment_data.orientation.z);
                attachment_data.position.x = parseFloat(attachment_data.position.x);
                attachment_data.position.y = parseFloat(attachment_data.position.y);
                attachment_data.position.z = parseFloat(attachment_data.position.z);
    
                // Update the position of the selected attachments
                if (round == true)
                {
                    var position = new THREE.Vector3(
                        Math.round(exact_position.x * 40) / 40,
                        Math.round(exact_position.y * 40) / 40,
                        Math.round(exact_position.z * 40) / 40
                    );
                }
                else
                {
                    var position = exact_position;
                }
                attachment.position.copy(position);
    
                // Update attachment data
                attachment_data.position = position;
                attachment.rotation.x = THREE.MathUtils.degToRad(attachment_data.orientation.x);
                attachment.rotation.y = THREE.MathUtils.degToRad(attachment_data.orientation.y);
                attachment.rotation.z = THREE.MathUtils.degToRad(attachment_data.orientation.z);
    
                if (!only_update_values) {
                    // Reposition for rotation
                    var relativePosition = new THREE.Vector3(0, 0.01, 0);
                    var rotationMatrix = new THREE.Matrix4();
                    rotationMatrix.extractRotation(attachment.matrixWorld); // Extract rotation matrix from cone's world matrix
                    relativePosition.applyMatrix4(rotationMatrix);
                    // attachment.rotation.copy();
                    // attachment.position.add(relativePosition);
                }
    
                eel.update_part({'attachments': this.attachments});
            } else if (link) {
                var link_data = this.SelectedLink();
                // Update with floats as this is the data we're expecting, not text
                link_data.position.x = parseFloat(link_data.position.x);
                link_data.position.y = parseFloat(link_data.position.y);
                link_data.position.z = parseFloat(link_data.position.z);
    
                // Update the position of the selected attachments
                if (round == true)
                {
                    var position = new THREE.Vector3(
                        Math.round(exact_position.x * 40) / 40,
                        Math.round(exact_position.y * 40) / 40,
                        Math.round(exact_position.z * 40) / 40
                    );
                }
                else
                {
                    var position = exact_position;
                }
                link.position.copy(position);
    
                // Update attachment data
                link_data.position = position;
    
                eel.update_part({'links': this.links});
            }

        },

        MouseDown(event) {
            if (event.button == 1)
            {
                return;
            }
            // Mouse coordinates
            var mouse = new THREE.Vector2();
            mouse.x = ((event.clientX - container.offsetLeft) / WIDTH) * 2 - 1;
            mouse.y = -((event.clientY - container.offsetTop) / HEIGHT) * 2 + 1;

            if (this.mode == "Attachments") {
                var selected_attachment = this.SelectedAttachmentObject();
                var selected_link = this.SelectedLinkObject();

                // Raycasting
                var raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, camera);

                // Intersect with attachments
                var intersects = raycaster.intersectObjects(scene.children, true).filter(obj => obj.object instanceof THREE.Mesh && obj.object != loaded_obj);

                if (intersects.length > 0) {
                    // Get the first intersected attachment
                    var obj = intersects[0].object;
                    if (obj.name == 'attachment') {
                        if (selected_attachment == obj) {
                            this.DeselectAttachment();
                            return;
                        }

                        this.DeselectLink();
                        this.SelectAttachmentByObject(obj);

                        if (event.button == 2) {
                            // TODO: ADD REMOVE FOR ATTACHMENTS
                            this.RemoveAttachmentByObject(obj);
                            event.preventDefault();
                            return;
                        }

                        return;
                    } else if (obj.name == 'link') {
                        if (selected_link == obj) {
                            this.DeselectLink();
                            return;
                        }

                        this.DeselectAttachment();
                        this.SelectLinkByObject(obj);

                        if (event.button == 2) {
                            // TODO: ADD REMOVE FOR ATTACHMENTS
                            this.RemoveLinkByObject(obj);
                            event.preventDefault();
                            return;
                        }

                        return;
                    }
                }

                // Intersect with all
                var intersects = raycaster.intersectObjects(scene.children, true).filter(obj => obj.object instanceof THREE.Mesh);

                if (!selected_attachment && event.ctrlKey) {
                    // Raycasting
                    var raycaster = new THREE.Raycaster();
                    raycaster.setFromCamera(mouse, camera);

                    // Intersect with your model
                    var intersects = raycaster.intersectObjects(scene.children, true);

                    if (intersects.length > 0) {
                        var intersectionPoint = intersects[0].point;
                        if (event.shiftKey) {
                            this.AddNewLink(intersectionPoint);
                        } else {
                            this.AddNewAttachment(intersectionPoint);
                        }
                    }
                } 
            }
        },
        
        MouseMove(event) {
            var selected_attachment = this.SelectedAttachmentObject();
            var selected_link = this.SelectedLinkObject();
            // Mouse coordinates
            var mouse = new THREE.Vector2();
            mouse.x = ((event.clientX - container.offsetLeft) / WIDTH) * 2 - 1;
            mouse.y = -((event.clientY - container.offsetTop) / HEIGHT) * 2 + 1;

            // Raycasting
            var raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            // Intersect with the plane
            var scene_objects = scene.children;
            if (selected_attachment) {
                scene_objects = scene_objects.filter(obj => obj !== selected_attachment);
            } else if (selected_link) {
                scene_objects = scene_objects.filter(obj => obj !== selected_link);
            }
            var intersects = raycaster.intersectObjects(scene_objects, true);

            if (intersects.length > 0) {
                if ((selected_attachment || selected_link) && event.ctrlKey) {
                    this.updatePositioning(intersects[0].point, true, false);
                }
            }
        },

        KeyDown(event) {
            var selected_attachment = this.SelectedAttachmentObject();

            // Keys not dependent on a selected attachment
            if (event.ctrlKey) {
                switch (event.keyCode) {
                    case 49: // 1
                        this.UpdateMode('View');
                        break;
                    case 50: // 2
                        this.UpdateMode('Attachments');
                        break;
                    case 51: // 3
                        this.UpdateMode('Scripting');
                        break;
                    case 52: // 4
                        this.UpdateMode('Tweakables');
                        break;
                }
            }

            // Keys dependent on a selected attachment
            if (!selected_attachment)
                return;
              
            switch (event.keyCode) {
                case 27: // Escape
                    this.DeselectAttachment();
                    break;
            }
        },
    }));

    function Update3DContainer() {
        WIDTH = container.offsetWidth;
        HEIGHT = container.offsetHeight;
        camera.aspect = WIDTH / HEIGHT;
        camera.updateProjectionMatrix();
        renderer.setSize(WIDTH, HEIGHT);
    }

    window.addEventListener('resize', function() {
        Update3DContainer();
    });


    var container;
    var WIDTH;
    var HEIGHT;

    var scene;
    var camera;
    var renderer;
    var controls;

    // var rotation = new THREE.Euler(THREE.MathUtils.degToRad(0), THREE.MathUtils.degToRad(0), THREE.MathUtils.degToRad(0))
    var loaded_obj = null;

    

    function animate(){
        renderer.render(scene,camera);
        requestAnimationFrame(animate);
    }

    
    function init3js() {
        container = document.getElementById('3js');
        WIDTH = container.offsetWidth;
        HEIGHT = container.offsetHeight;
        line = null;
        gridHelper = null;
        axisHelper = null;

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, WIDTH/HEIGHT, 0.01, 100);
        renderer = new THREE.WebGLRenderer({antialias:true});
        controls = new THREE.OrbitControls(camera,  renderer.domElement);

        scene.background = new THREE.Color(0x151515);
        camera.position.z = 0.5; // Default zoom so to speak
        renderer.setSize(WIDTH, HEIGHT);
        container.appendChild(renderer.domElement);

        showGrid( true );
        showAxis( true );

        // Add some lights
        var light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
        light.position.set(0, 1, 0);
        scene.add(light);

        var light2 = new THREE.DirectionalLight(0xffffff, 1.0);
        light2.position.set(0, 1, 0);
        scene.add(light2);

        controls.addEventListener('change', renderer);

        animate();
    }

    async function upload(path, file_name, event) {
        return new Promise((resolve, reject) => {
            let file = event.target.files[0];
            let reader = new FileReader();
            reader.readAsBinaryString(file);
            reader.onload = e => {
                let data = e.target.result;
                eel.write_data(path, file_name, data);
                resolve(data);
            }
        });
    }

    async function uploadOBJ(event) {
        return new Promise((resolve, reject) => {
            let file = event.target.files[0];
            let reader = new FileReader();

            reader.readAsText(file);
            reader.onload = e => {
                let data = e.target.result;
                eel.write_part_obj(data);
                loadOBJ(data);
                resolve(data);
            }
        });
    }

    function loadOBJ(data) {
        const loader = new THREE.OBJLoader();
        scene.remove(loaded_obj);
        loaded_obj = loader.parse(data).children[0];
        scene.add(loaded_obj);
    }

    function showWireframe( boolean ) {
        if ( loaded_obj ) {
            if (!line && boolean ) {
                wireframe = new THREE.WireframeGeometry(loaded_obj.geometry);
                line = new THREE.LineSegments(wireframe);
                line.material.depthTest = true;
                line.material.color = new THREE.Color(0xffa500);
                line.material.opacity = 0.9;
                line.material.transparent = true;
                scene.add(line);
            } else if (line && !boolean ) {
                console.log('Deleting Wireframe');
                scene.remove(line);
                line = null;
            }
        }
    }

    function showGrid( boolean ) {
        if ( !gridHelper && boolean ) {
            gridHelper = new  THREE.GridHelper( 4.5, 45 );
            scene.add(gridHelper);
        } else if ( gridHelper && !boolean ) {
            scene.remove(gridHelper);
            gridHelper = null;
        } else {
            console.log('no gridHelper');
        }
    }

    function showAxis( boolean ) {
        if ( !axisHelper && boolean ) {
            axisHelper = new THREE.AxesHelper( 2.25 );
            scene.add(axisHelper);
        } else if ( axisHelper && !boolean ) {
            scene.remove(axisHelper);
            axisHelper = null;
        }
    }

    function setTransparency(transparency) {
        // Iterate through the children of the loaded object
        loaded_obj.traverse(function(child) {
            // Check if the child has a material
            if (child.material) {
                // Set the opacity of the material
                child.material.opacity = transparency; // Set opacity to 50%
                child.material.transparent = true; // Enable transparency
            }
        });
    }

    init();

    // // Disable right click on editor page
    document.addEventListener('contextmenu', function(event) {
        event.preventDefault();
    });
</script>